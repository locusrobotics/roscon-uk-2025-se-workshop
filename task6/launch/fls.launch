<?xml version="1.0" encoding="UTF-8"?>

<launch>

  <arg name="include_imu" default="False"/>
  <arg name="include_imu_vo" default="False"/>

  <let name="odometry_only" value="$(eval 'not $(var include_imu) and not $(var include_imu_vo)')"/>
  <let name="odometry_imu" value="$(eval '$(var include_imu) or $(var include_imu_vo)')"/>
  <let name="odometry_imu_vo" value="$(var include_imu_vo)"/>

  <include file="$(find-pkg-share r2d2_description)/launch/description.launch.py"/>

  <!-- Always run the wheel encoder-only instances -->
  <node pkg="fuse_optimizers" exec="fixed_lag_smoother_node" name="fls_node_odometry" namespace="r2d2">
    <param name="use_sim_time" value="true"/>
    <param from="$(find-pkg-share task6)/config/odometry.yaml"/>
    <param name="filtered_publisher.publish_tf" value="$(var odometry_only)"/>
  </node>

  <node pkg="robot_localization" exec="ekf_node" name="ekf_node_odometry" namespace="r2d2">
    <param name="use_sim_time" value="true"/>
    <param from="$(find-pkg-share task1)/config/odometry.yaml"/>
    <param name="publish_tf" value="false"/>
    <remap from="odometry/filtered" to="odometry/filtered_ekf"/>
  </node>

  <!-- Run the odometry + IMU instance if we have include_imu or include_imu_vo -->
  <group if="$(var odometry_imu)">
    <node pkg="fuse_optimizers" exec="fixed_lag_smoother_node" name="fls_node_odometry_imu" namespace="r2d2">
      <param name="use_sim_time" value="true"/>
      <param from="$(find-pkg-share task6)/config/odometry_imu.yaml"/>
      <param name="filtered_publisher.publish_tf" value="$(eval '$(var odometry_imu) and not $(var odometry_imu_vo)')"/>
    </node>

    <node pkg="robot_localization" exec="ekf_node" name="ekf_node_odometry_imu" namespace="r2d2">
      <param name="use_sim_time" value="true"/>
      <param from="$(find-pkg-share task1)/config/odometry_imu.yaml"/>
      <param name="publish_tf" value="false"/>
      <remap from="odometry/filtered" to="odometry/filtered_imu_ekf"/>
    </node>
  </group>

  <!-- Run the odometry + IMU + VO instance if we have include_imu_vo -->
  <group if="$(var odometry_imu_vo)">
    <node pkg="fuse_optimizers" exec="fixed_lag_smoother_node" name="fls_node_odometry_imu_vo" namespace="r2d2">
      <param name="use_sim_time" value="true"/>
      <param from="$(find-pkg-share task6)/config/odometry_imu_vo.yaml"/>
      <param name="filtered_publisher.publish_tf" value="$(var odometry_imu_vo)"/>
    </node>

    <node pkg="robot_localization" exec="ekf_node" name="ekf_node_odometry_imu_vo" namespace="r2d2">
      <param name="use_sim_time" value="true"/>
      <param from="$(find-pkg-share task1)/config/odometry_imu_vo.yaml"/>
      <param name="publish_tf" value="false"/>
      <remap from="odometry/filtered" to="odometry/filtered_imu_vo_ekf"/>
    </node>
  </group>

  <let name="rviz_config" value="odometry.rviz" if="$(var odometry_only)"/>
  <let name="rviz_config" value="odometry_imu.rviz" if="$(eval '$(var odometry_imu) and not $(var odometry_imu_vo)')"/>
  <let name="rviz_config" value="odometry_imu_vo.rviz" if="$(var odometry_imu_vo)"/>

  <node pkg="rviz2" exec="rviz2" args="-d $(find-pkg-share task6)/config/$(var rviz_config)" name="rviz">
    <param name="use_sim_time" value="true"/>
  </node>

</launch>
